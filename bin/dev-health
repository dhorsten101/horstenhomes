#!/usr/bin/env bash
set -euo pipefail

WEB_NAME="${WEB_NAME:-hh-web}"
WEB_PORT="${WEB_PORT:-8000}"

# Tenant domain to test (override if needed)
TENANT_DOMAIN="${TENANT_DOMAIN:-acme.horstenhomes.local}"

echo "==============================="
echo " HorstenHomes Dev Health Check"
echo "==============================="
echo ""

if ! docker info >/dev/null 2>&1; then
  echo "❌ Docker daemon: NOT RUNNING"
  exit 1
fi
echo "✅ Docker daemon: running"
echo ""

if ! docker ps --format '{{.Names}}' | grep -q "^${WEB_NAME}$"; then
  echo "❌ Web container '${WEB_NAME}' is NOT running"
  echo "   Start with: ./bin/dev-up"
  exit 1
fi
echo "✅ Web container: ${WEB_NAME} running"
echo ""

check() {
  local name="$1"
  local url="$2"
  local host="$3"

  # -s silent, -o discard body, -w status code, --max-time for fast failure
  local code
  code="$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 -H "Host: ${host}" "${url}" || true)"

  if [[ "${code}" == "200" || "${code}" == "302" || "${code}" == "301" ]]; then
    echo "✅ ${name}: ${code}  (${url}  Host=${host})"
    return 0
  fi

  echo "❌ ${name}: ${code}  (${url}  Host=${host})"
  return 1
}

BASE_URL="http://127.0.0.1:${WEB_PORT}"

echo "▶ Checking tenant routing using Host header (bypasses local DNS)"
fail=0
check "Tenant /"        "${BASE_URL}/"        "${TENANT_DOMAIN}" || fail=1
check "Tenant /admin/"  "${BASE_URL}/admin/"  "${TENANT_DOMAIN}" || fail=1

echo ""
echo "▶ Checking localhost routing (optional convenience)"
check "Localhost /"        "${BASE_URL}/"        "localhost" || true
check "Localhost /admin/"  "${BASE_URL}/admin/"  "localhost" || true

echo ""
if [[ "${fail}" -eq 0 ]]; then
  echo "✅ Health indicates the dev stack is operational."
else
  echo "❌ Health failed. Typical causes:"
  echo "   - tenant domain not created in Domain table"
  echo "   - tenant schema not migrated"
  echo "   - admin not installed/migrated in the schema being hit"
  exit 2
fi
