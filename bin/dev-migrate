#!/usr/bin/env bash
set -euo pipefail

WEB_NAME="${WEB_NAME:-hh-web}"
ENV_FILE="${ENV_FILE:-.env.dev}"

# Usage:
#   ./bin/dev-migrate shared
#   ./bin/dev-migrate tenant acme
#   ./bin/dev-migrate tenants
#   ./bin/dev-migrate all            # shared + all tenants
#   ./bin/dev-migrate all acme       # shared + one tenant
#   ./bin/dev-migrate make
#   ./bin/dev-migrate make tenancy
#
# Notes:
# - Requires hh-web running (same env + code mount used).
# - Uses django-tenants migrate_schemas correctly.
# - "tenants" migrates every tenant schema in the Tenant table.

if [[ ! -f "${ENV_FILE}" ]]; then
  echo "❌ Missing env file: ${ENV_FILE}"
  exit 1
fi

if ! docker ps --format '{{.Names}}' | grep -q "^${WEB_NAME}$"; then
  echo "❌ ${WEB_NAME} is not running. Start it first:"
  echo "   ./bin/dev up"
  exit 1
fi

CMD="${1:-}"
ARG="${2:-}"

case "${CMD}" in
  make)
    if [[ -n "${ARG}" ]]; then
      echo "▶ makemigrations ${ARG}"
      docker exec -it "${WEB_NAME}" python manage.py makemigrations "${ARG}"
    else
      echo "▶ makemigrations"
      docker exec -it "${WEB_NAME}" python manage.py makemigrations
    fi
    ;;

  shared)
    echo "▶ migrate_schemas --shared"
    docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --shared
    ;;

  tenant)
    if [[ -z "${ARG}" ]]; then
      echo "❌ Missing tenant schema name. Example:"
      echo "   ./bin/dev migrate tenant acme"
      exit 1
    fi
    echo "▶ migrate_schemas --schema=${ARG}"
    docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --schema="${ARG}"
    ;;

  tenants)
    # all tenants (every schema except public)
    echo "▶ migrate_schemas --tenant"
    docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --tenant
    ;;

  all)
    # shared + all tenants (default deploy sequence)
    if [[ -z "${ARG}" ]]; then
      echo "▶ migrate_schemas --shared"
      docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --shared
      echo "▶ migrate_schemas --tenant"
      docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --tenant
    else
      # shared + one tenant schema in sequence (handy during dev)
      echo "▶ migrate_schemas --shared"
      docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --shared
      echo "▶ migrate_schemas --schema=${ARG}"
      docker exec -it "${WEB_NAME}" python manage.py migrate_schemas --schema="${ARG}"
    fi
    ;;

  *)
    echo "Usage:"
    echo "  ./bin/dev migrate make [app_label]"
    echo "  ./bin/dev migrate shared"
    echo "  ./bin/dev migrate tenant <schema>"
    echo "  ./bin/dev migrate tenants"
    echo "  ./bin/dev migrate all            # shared + all tenants"
    echo "  ./bin/dev migrate all <schema>   # shared + one tenant"
    exit 2
    ;;
esac